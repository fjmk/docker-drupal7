#!/bin/bash
DEBUG_STATEMENTS="debug_backtrace\( \sprint_r\( var_dump\( dsm\( dpm\( dvm\( dpr\( dvr\( kpr\( dargs\( \sdd\( ddebug_backtrace\( db_queryd\( firep\( dfb\(" 
## FILE_IGNORE="--ignore */devel/* --ignore *example* --ignore *LocalFileImpl.php --ignore *ZipFile.class.php --ignore *includes/general.php --ignore *page_manager.admin.inc --ignore *views.module"

rm -f $REPORTS_DIR/debug-code.txt

# ag and bash needs space separated TEST_DIRS
IGNORE_DIRS=`echo $IGNORE_TEST_DIRS |sed -e "s/,/ /g"`
IGNORE_FILES=`echo $IGNORE_TEST_FILES |sed -e "s/,/ /g"`
TEST_DIRS=`echo $INCLUDE_TEST_DIRS |sed -e "s/,/ /g"`

IGNORE=''
for i in $IGNORE_DIRS; do
    IGNORE="$IGNORE --ignore *$i/*"
done
for i in $IGNORE_FILES; do
    IGNORE="$IGNORE --ignore $i"
done

# all directories
##for a in $DEBUG_STATEMENTS; do
##  ag $IGNORE "((^\s{0,})|(\;\s{0,}))$a" $INCLUDE_TEST_DIRS/ >>$REPORTS_DIR/debug-code.txt
##done

for a in $TEST_DIRS; do
  for b in $DEBUG_STATEMENTS; do
    ag --color --color-path='1;31' $IGNORE "((^\s{0,})|(\;\s{0,}))$b" $a/ 2>&1 >> $REPORTS_DIR/debug-code.txt
  done
done

AG_RESULT=`cat $REPORTS_DIR/debug-code.txt | wc -l`

if [ "$AG_RESULT" -gt "0" ]; then
  echo
  echo "drupal-debug-test:      Debug statements found."
  echo "                        Please check following files:"
  echo
  cat $REPORTS_DIR/debug-code.txt
  exit 1
fi

rm -f $REPORTS_DIR/debug-code.txt
echo
echo "drupal-debug-test:        No debug statements found."
echo

exit 0

